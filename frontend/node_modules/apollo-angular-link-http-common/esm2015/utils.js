import { Observable } from 'rxjs';
import { extractFiles } from 'extract-files';
export const fetch = (req, httpClient) => {
    const shouldUseBody = ['POST', 'PUT', 'PATCH'].indexOf(req.method.toUpperCase()) !== -1;
    const shouldStringify = (param) => ['variables', 'extensions'].indexOf(param.toLowerCase()) !== -1;
    const isBatching = req.body.length;
    let shouldUseMultipart = req.options && req.options.useMultipart;
    let multipartInfo;
    if (shouldUseMultipart) {
        if (isBatching) {
            return new Observable(observer => observer.error(new Error('File upload is not available when combined with Batching')));
        }
        if (!shouldUseBody) {
            return new Observable(observer => observer.error(new Error('File upload is not available when GET is used')));
        }
        multipartInfo = extractFiles(req.body);
        shouldUseMultipart = !!multipartInfo.files.size;
    }
    // `body` for some, `params` for others
    let bodyOrParams = {};
    if (isBatching) {
        if (!shouldUseBody) {
            return new Observable(observer => observer.error(new Error('Batching is not available for GET requests')));
        }
        bodyOrParams = {
            body: req.body,
        };
    }
    else {
        const body = shouldUseMultipart ? multipartInfo.clone : req.body;
        if (shouldUseBody) {
            bodyOrParams = {
                body,
            };
        }
        else {
            const params = Object.keys(req.body).reduce((obj, param) => {
                const value = req.body[param];
                obj[param] = shouldStringify(param) ? JSON.stringify(value) : value;
                return obj;
            }, {});
            bodyOrParams = { params: params };
        }
    }
    if (shouldUseMultipart && shouldUseBody) {
        const form = new FormData();
        form.append('operations', JSON.stringify(bodyOrParams.body));
        const map = {};
        const files = multipartInfo.files;
        let i = 0;
        files.forEach(paths => {
            map[++i] = paths;
        });
        form.append('map', JSON.stringify(map));
        i = 0;
        files.forEach((_, file) => {
            form.append(++i + '', file, file.name);
        });
        bodyOrParams.body = form;
    }
    // create a request
    return httpClient.request(req.method, req.url, Object.assign({ observe: 'response', responseType: 'json', reportProgress: false }, bodyOrParams, req.options));
};
export const mergeHeaders = (source, destination) => {
    if (source && destination) {
        const merged = destination
            .keys()
            .reduce((headers, name) => headers.set(name, destination.getAll(name)), source);
        return merged;
    }
    return destination || source;
};
export function prioritize(...values) {
    const picked = values.find(val => typeof val !== 'undefined');
    if (typeof picked === 'undefined') {
        return values[values.length - 1];
    }
    return picked;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9hcG9sbG8tYW5ndWxhci1saW5rLWh0dHAtY29tbW9uLyIsInNvdXJjZXMiOlsidXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNoQyxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBSTNDLE1BQU0sQ0FBQyxNQUFNLEtBQUssR0FBRyxDQUNuQixHQUFZLEVBQ1osVUFBc0IsRUFDWSxFQUFFO0lBQ3BDLE1BQU0sYUFBYSxHQUNqQixDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUNwRSxNQUFNLGVBQWUsR0FBRyxDQUFDLEtBQWEsRUFBRSxFQUFFLENBQ3hDLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUNsRSxNQUFNLFVBQVUsR0FBSSxHQUFHLENBQUMsSUFBZSxDQUFDLE1BQU0sQ0FBQztJQUMvQyxJQUFJLGtCQUFrQixHQUFHLEdBQUcsQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUM7SUFDakUsSUFBSSxhQUdILENBQUM7SUFFRixJQUFJLGtCQUFrQixFQUFFO1FBQ3RCLElBQUksVUFBVSxFQUFFO1lBQ2QsT0FBTyxJQUFJLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUMvQixRQUFRLENBQUMsS0FBSyxDQUNaLElBQUksS0FBSyxDQUFDLDBEQUEwRCxDQUFDLENBQ3RFLENBQ0YsQ0FBQztTQUNIO1FBRUQsSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUNsQixPQUFPLElBQUksVUFBVSxDQUFDLFFBQVEsQ0FBQyxFQUFF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RSxNQUFNLEVBQ3BCLGNBQWMsRUFBRSxLQUFLLElBQ2xCLFlBQVksRUFDWixHQUFHLENBQUMsT0FBTyxFQUNkLENBQUM7QUFDTCxDQUFDLENBQUM7QUFFRixNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsQ0FDMUIsTUFBbUIsRUFDbkIsV0FBd0IsRUFDWCxFQUFFO0lBQ2YsSUFBSSxNQUFNLElBQUksV0FBVyxFQUFFO1FBQ3pCLE1BQU0sTUFBTSxHQUFHLFdBQVc7YUFDdkIsSUFBSSxFQUFFO2FBQ04sTUFBTSxDQUNMLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUM5RCxNQUFNLENBQ1AsQ0FBQztRQUVKLE9BQU8sTUFBTSxDQUFDO0tBQ2Y7SUFFRCxPQUFPLFdBQVcsSUFBSSxNQUFNLENBQUM7QUFDL0IsQ0FBQyxDQUFDO0FBRUYsTUFBTSxVQUFVLFVBQVUsQ0FBSSxHQUFHLE1BQVc7SUFDMUMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sR0FBRyxLQUFLLFdBQVcsQ0FBQyxDQUFDO0lBRTlELElBQUksT0FBTyxNQUFNLEtBQUssV0FBVyxFQUFFO1FBQ2pDLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7S0FDbEM7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtIdHRwSGVhZGVycywgSHR0cFJlc3BvbnNlLCBIdHRwQ2xpZW50fSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtleHRyYWN0RmlsZXN9IGZyb20gJ2V4dHJhY3QtZmlsZXMnO1xuXG5pbXBvcnQge1JlcXVlc3QsIEJvZHl9IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQgY29uc3QgZmV0Y2ggPSAoXG4gIHJlcTogUmVxdWVzdCxcbiAgaHR0cENsaWVudDogSHR0cENsaWVudCxcbik6IE9ic2VydmFibGU8SHR0cFJlc3BvbnNlPE9iamVjdD4+ID0+IHtcbiAgY29uc3Qgc2hvdWxkVXNlQm9keSA9XG4gICAgWydQT1NUJywgJ1BVVCcsICdQQVRDSCddLmluZGV4T2YocmVxLm1ldGhvZC50b1VwcGVyQ2FzZSgpKSAhPT0gLTE7XG4gIGNvbnN0IHNob3VsZFN0cmluZ2lmeSA9IChwYXJhbTogc3RyaW5nKSA9PlxuICAgIFsndmFyaWFibGVzJywgJ2V4dGVuc2lvbnMnXS5pbmRleE9mKHBhcmFtLnRvTG93ZXJDYXNlKCkpICE9PSAtMTtcbiAgY29uc3QgaXNCYXRjaGluZyA9IChyZXEuYm9keSBhcyBCb2R5W10pLmxlbmd0aDtcbiAgbGV0IHNob3VsZFVzZU11bHRpcGFydCA9IHJlcS5vcHRpb25zICYmIHJlcS5vcHRpb25zLnVzZU11bHRpcGFydDtcbiAgbGV0IG11bHRpcGFydEluZm86IHtcbiAgICBjbG9uZTogQm9keTtcbiAgICBmaWxlczogTWFwPGFueSwgYW55PjtcbiAgfTtcblxuICBpZiAoc2hvdWxkVXNlTXVsdGlwYXJ0KSB7XG4gICAgaWYgKGlzQmF0Y2hpbmcpIHtcbiAgICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShvYnNlcnZlciA9PlxuICAgICAgICBvYnNlcnZlci5lcnJvcihcbiAgICAgICAgICBuZXcgRXJyb3IoJ0ZpbGUgdXBsb2FkIGlzIG5vdCBhdmFpbGFibGUgd2hlbiBjb21iaW5lZCB3aXRoIEJhdGNoaW5nJyksXG4gICAgICAgICksXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICghc2hvdWxkVXNlQm9keSkge1xuICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKG9ic2VydmVyID0+XG4gICAgICAgIG9ic2VydmVyLmVycm9yKFxuICAgICAgICAgIG5ldyBFcnJvcignRmlsZSB1cGxvYWQgaXMgbm90IGF2YWlsYWJsZSB3aGVuIEdFVCBpcyB1c2VkJyksXG4gICAgICAgICksXG4gICAgICApO1xuICAgIH1cblxuICAgIG11bHRpcGFydEluZm8gPSBleHRyYWN0RmlsZXMocmVxLmJvZHkpO1xuXG4gICAgc2hvdWxkVXNlTXVsdGlwYXJ0ID0gISFtdWx0aXBhcnRJbmZvLmZpbGVzLnNpemU7XG4gIH1cblxuICAvLyBgYm9keWAgZm9yIHNvbWUsIGBwYXJhbXNgIGZvciBvdGhlcnNcbiAgbGV0IGJvZHlPclBhcmFtcyA9IHt9O1xuXG4gIGlmIChpc0JhdGNoaW5nKSB7XG4gICAgaWYgKCFzaG91bGRVc2VCb2R5KSB7XG4gICAgICByZXR1cm4gbmV3IE9ic2VydmFibGUob2JzZXJ2ZXIgPT5cbiAgICAgICAgb2JzZXJ2ZXIuZXJyb3IobmV3IEVycm9yKCdCYXRjaGluZyBpcyBub3QgYXZhaWxhYmxlIGZvciBHRVQgcmVxdWVzdHMnKSksXG4gICAgICApO1xuICAgIH1cblxuICAgIGJvZHlPclBhcmFtcyA9IHtcbiAgICAgIGJvZHk6IHJlcS5ib2R5LFxuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgYm9keSA9IHNob3VsZFVzZU11bHRpcGFydCA/IG11bHRpcGFydEluZm8hLmNsb25lIDogcmVxLmJvZHk7XG5cbiAgICBpZiAoc2hvdWxkVXNlQm9keSkge1xuICAgICAgYm9keU9yUGFyYW1zID0ge1xuICAgICAgICBib2R5LFxuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcGFyYW1zID0gT2JqZWN0LmtleXMocmVxLmJvZHkpLnJlZHVjZSgob2JqOiBhbnksIHBhcmFtKSA9PiB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gKHJlcS5ib2R5IGFzIGFueSlbcGFyYW1dO1xuICAgICAgICBvYmpbcGFyYW1dID0gc2hvdWxkU3RyaW5naWZ5KHBhcmFtKSA/IEpTT04uc3RyaW5naWZ5KHZhbHVlKSA6IHZhbHVlO1xuICAgICAgICByZXR1cm4gb2JqO1xuICAgICAgfSwge30pO1xuXG4gICAgICBib2R5T3JQYXJhbXMgPSB7cGFyYW1zOiBwYXJhbXN9O1xuICAgIH1cbiAgfVxuXG4gIGlmIChzaG91bGRVc2VNdWx0aXBhcnQgJiYgc2hvdWxkVXNlQm9keSkge1xuICAgIGNvbnN0IGZvcm0gPSBuZXcgRm9ybURhdGEoKTtcblxuICAgIGZvcm0uYXBwZW5kKCdvcGVyYXRpb25zJywgSlNPTi5zdHJpbmdpZnkoKGJvZHlPclBhcmFtcyBhcyBhbnkpLmJvZHkpKTtcblxuICAgIGNvbnN0IG1hcDogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xuICAgIGNvbnN0IGZpbGVzID0gbXVsdGlwYXJ0SW5mbyEuZmlsZXM7XG5cbiAgICBsZXQgaSA9IDA7XG4gICAgZmlsZXMuZm9yRWFjaChwYXRocyA9PiB7XG4gICAgICBtYXBbKytpXSA9IHBhdGhzO1xuICAgIH0pO1xuXG4gICAgZm9ybS5hcHBlbmQoJ21hcCcsIEpTT04uc3RyaW5naWZ5KG1hcCkpO1xuXG4gICAgaSA9IDA7XG4gICAgZmlsZXMuZm9yRWFjaCgoXywgZmlsZSkgPT4ge1xuICAgICAgZm9ybS5hcHBlbmQoKytpICsgJycsIGZpbGUsIGZpbGUubmFtZSk7XG4gICAgfSk7XG5cbiAgICAoYm9keU9yUGFyYW1zIGFzIGFueSkuYm9keSA9IGZvcm07XG4gIH1cblxuICAvLyBjcmVhdGUgYSByZXF1ZXN0XG4gIHJldHVybiBodHRwQ2xpZW50LnJlcXVlc3Q8T2JqZWN0PihyZXEubWV0aG9kLCByZXEudXJsLCB7XG4gICAgb2JzZXJ2ZTogJ3Jlc3BvbnNlJyxcbiAgICByZXNwb25zZVR5cGU6ICdqc29uJyxcbiAgICByZXBvcnRQcm9ncmVzczogZmFsc2UsXG4gICAgLi4uYm9keU9yUGFyYW1zLFxuICAgIC4uLnJlcS5vcHRpb25zLFxuICB9KTtcbn07XG5cbmV4cG9ydCBjb25zdCBtZXJnZUhlYWRlcnMgPSAoXG4gIHNvdXJjZTogSHR0cEhlYWRlcnMsXG4gIGRlc3RpbmF0aW9uOiBIdHRwSGVhZGVycyxcbik6IEh0dHBIZWFkZXJzID0+IHtcbiAgaWYgKHNvdXJjZSAmJiBkZXN0aW5hdGlvbikge1xuICAgIGNvbnN0IG1lcmdlZCA9IGRlc3RpbmF0aW9uXG4gICAgICAua2V5cygpXG4gICAgICAucmVkdWNlKFxuICAgICAgICAoaGVhZGVycywgbmFtZSkgPT4gaGVhZGVycy5zZXQobmFtZSwgZGVzdGluYXRpb24uZ2V0QWxsKG5hbWUpKSxcbiAgICAgICAgc291cmNlLFxuICAgICAgKTtcblxuICAgIHJldHVybiBtZXJnZWQ7XG4gIH1cblxuICByZXR1cm4gZGVzdGluYXRpb24gfHwgc291cmNlO1xufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHByaW9yaXRpemU8VD4oLi4udmFsdWVzOiBUW10pOiBUIHtcbiAgY29uc3QgcGlja2VkID0gdmFsdWVzLmZpbmQodmFsID0+IHR5cGVvZiB2YWwgIT09ICd1bmRlZmluZWQnKTtcblxuICBpZiAodHlwZW9mIHBpY2tlZCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICByZXR1cm4gdmFsdWVzW3ZhbHVlcy5sZW5ndGggLSAxXTtcbiAgfVxuXG4gIHJldHVybiBwaWNrZWQ7XG59XG4iXX0=